<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Oaysus Component Demo - Import Maps + ESM</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Import Map: Will be injected dynamically from build output -->

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background: #f9fafb;
    }
    .demo-header {
      max-width: 1200px;
      margin: 0 auto 20px;
      background: white;
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .demo-header h1 {
      margin: 0 0 8px 0;
      font-size: 28px;
      font-weight: 700;
      color: #111827;
    }
    .demo-header p {
      margin: 0;
      color: #6b7280;
      font-size: 14px;
    }
    .status-panel {
      max-width: 1200px;
      margin: 0 auto 20px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .status-title {
      font-weight: 600;
      margin-bottom: 12px;
      color: #374151;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .status {
      padding: 10px 12px;
      margin-bottom: 8px;
      border-radius: 6px;
      font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
      font-size: 13px;
      border-left: 3px solid;
    }
    .status.success {
      background: #ecfdf5;
      color: #065f46;
      border-color: #10b981;
    }
    .status.error {
      background: #fef2f2;
      color: #991b1b;
      border-color: #ef4444;
    }
    .status.info {
      background: #eff6ff;
      color: #1e40af;
      border-color: #3b82f6;
    }
    .component-container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .component-wrapper {
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow: hidden;
      margin-bottom: 20px;
    }
    .component-label {
      padding: 12px 16px;
      background: #f3f4f6;
      border-bottom: 1px solid #e5e7eb;
      font-weight: 600;
      font-size: 14px;
      color: #374151;
    }
  </style>
</head>
<body>
  <div class="demo-header">
    <h1>üé® Oaysus Component Demo</h1>
    <p>Testing ESM components with Import Maps - Local Build</p>
  </div>

  <div class="status-panel">
    <div class="status-title">System Status</div>
    <div id="status-container"></div>
  </div>

  <div class="component-container" id="component-container"></div>

  <script type="module">
    const statusContainer = document.getElementById('status-container');
    const componentContainer = document.getElementById('component-container');

    function addStatus(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `status ${type}`;
      div.textContent = message;
      statusContainer.appendChild(div);
      console.log(`[${type.toUpperCase()}]`, message);
    }

    async function loadAndRenderComponents() {
      try {
        // Step 1: Load import map from build output
        addStatus('‚è≥ Loading import map from build...', 'info');

        const importMapRes = await fetch('/my-awesome-theme/.oaysus-build/import-map.json');
        if (!importMapRes.ok) {
          throw new Error('Import map not found. Run "oaysus push" to generate it.');
        }

        const importMapData = await importMapRes.json();

        // Inject import map into document
        const importMapScript = document.createElement('script');
        importMapScript.type = 'importmap';
        importMapScript.textContent = JSON.stringify(importMapData);
        document.head.appendChild(importMapScript);

        addStatus('‚úì Import map loaded from build output', 'success');
        addStatus(`‚úì Mapped ${Object.keys(importMapData.imports).length} module specifiers`, 'success');

        // Step 2: Now we can import React (resolved via import map)
        const { createElement } = await import('react');
        const { createRoot } = await import('react-dom/client');
        const React = await import('react');

        addStatus(`‚úì React ${React.version} loaded from LOCAL bundle`, 'success');
        addStatus('‚úì All dependencies bundled locally (no external CDNs)', 'success');

        // Step 2: Define components to load
        // Server root is oaysus-cli/, so path goes up to mono/ then into my-awesome-theme/
        const components = [
          {
            name: 'Hero',
            path: '/my-awesome-theme/.oaysus-build/Hero/index.js',
            props: {
              heading: 'Welcome to Oaysus Component System',
              subheading: 'Pre-built ESM components with Import Maps - No bundler needed!',
              buttonText: 'View on GitHub',
              buttonLink: 'https://github.com/yourusername/oaysus'
            }
          }
        ];

        // Step 3: Load and render each component
        for (const comp of components) {
          addStatus(`‚è≥ Loading ${comp.name} from ${comp.path}...`, 'info');

          try {
            // Dynamic ESM import - import map resolves "react" dependencies
            const componentUrl = comp.path;
            const module = await import(/* @vite-ignore */ componentUrl);
            const Component = module.default;

            if (!Component || typeof Component !== 'function') {
              throw new Error('No valid default export found in component module');
            }

            addStatus(`‚úì ${comp.name} module loaded successfully`, 'success');

            // Create wrapper div for component
            const wrapper = document.createElement('div');
            wrapper.className = 'component-wrapper';

            const label = document.createElement('div');
            label.className = 'component-label';
            label.textContent = `Component: ${comp.name}`;
            wrapper.appendChild(label);

            const compDiv = document.createElement('div');
            wrapper.appendChild(compDiv);

            componentContainer.appendChild(wrapper);

            // Render component with React
            const root = createRoot(compDiv);
            root.render(createElement(Component, comp.props));

            addStatus(`‚úì ${comp.name} rendered to DOM`, 'success');

          } catch (err) {
            addStatus(`‚úó Failed to load ${comp.name}: ${err.message}`, 'error');
            console.error(`Error loading ${comp.name}:`, err);

            // Show error in UI
            const errorDiv = document.createElement('div');
            errorDiv.className = 'component-wrapper';
            errorDiv.innerHTML = `
              <div class="component-label">Component: ${comp.name}</div>
              <div style="padding: 20px;">
                <div class="status error">
                  <strong>Error:</strong> ${err.message}<br>
                  <small>Check console for details</small>
                </div>
              </div>
            `;
            componentContainer.appendChild(errorDiv);
          }
        }

        // Step 4: Summary
        addStatus('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');
        addStatus('‚úÖ Demo complete! All components loaded.', 'success');
        addStatus('üí° Open browser console to see import map details', 'info');

        // Log import map details to console
        console.group('üìã Import Map Details');
        const loadedImportMapScript = document.querySelector('script[type="importmap"]');
        const loadedImportMap = JSON.parse(loadedImportMapScript.textContent);
        console.log('Import Map:', loadedImportMap);
        console.log('React Instance:', React);
        console.log('React Version:', React.version);
        console.groupEnd();

        console.group('üîç Verification');
        console.log('‚úÖ Only ONE React instance loaded (shared by all components)');
        console.log('‚úÖ Dependencies resolved via import map (no bundler)');
        console.log('‚úÖ Components loaded as native ESM modules');
        console.log('‚úÖ Production-ready code (no dev metadata)');
        console.groupEnd();

      } catch (error) {
        addStatus(`‚úó Fatal error: ${error.message}`, 'error');
        console.error('Demo failed:', error);
      }
    }

    // Initialize demo
    addStatus('üöÄ Starting component demo...', 'info');
    loadAndRenderComponents();
  </script>
</body>
</html>
